name: Continuous Integration

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  check:
    name: Check
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: âš™ï¸ Install golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9
        with:
          version: v2.9
          install-only: true

      - name: ðŸ“ Check lints and formatting
        run: just check

  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ§ª Run unit tests
        run: just test

      - name: â¬†ï¸ Upload coverage report
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: test-coverage
          path: coverage.out

  benchmark:
    name: Benchmark
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ“Š Run benchmarks
        run: just benchmark

      - name: â¬†ï¸ Upload benchmark results
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: benchmark-results
          path: benchmark-results.txt

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: [check]
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ§ª Run integration tests
        run: go test -v -tags=integration -run TestIntegration ./tests/...

  build:
    needs: [test, integration-test, check, benchmark]
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ·ï¸ Get project version
        id: get_version
        run: echo "VERSION=$(grep '^const Version' cmd/smaug/version.go | cut -d '"' -f 2)" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Build binary
        run: just build-release ${{ steps.get_version.outputs.VERSION }}

      - name: â¬†ï¸ Upload binary artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
        with:
          name: smaug-${{ github.sha }}
          path: bin/smaug

  security:
    name: Security Scan
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
      contents: read
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: ðŸ”’ Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: â¬†ï¸ Upload SARIF file
        uses: github/codeql-action/upload-sarif@b0ed4dedcb6dac75e55f599c0ac323404c92645a
        with:
          sarif_file: results.sarif

  sonar:
    needs: [test, integration-test, check, build]
    name: Sonar Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6.3.0
        with:
          go-version: '1.26.0'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@f8a3cce218d9f83db3a2ecd90e41ac3de6cdfd9b # v3
        with:
          just-version: "1.40.0"

      - name: â¬‡ï¸ Download test coverage report
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8
        with:
          name: test-coverage
          path: ./

      - name: ðŸ·ï¸ Get project version
        id: get_version
        run: echo "VERSION=$(grep '^const Version' cmd/smaug/version.go | cut -d '"' -f 2)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache SonarCloud packages
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ hashFiles('**/sonar-project.properties') }}
          restore-keys: ${{ runner.os }}-sonar

      - name: ðŸ” SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        with:
          args: >
            -Dsonar.scm.revision=${{ github.sha }}
            -Dsonar.projectVersion=${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
